<!DOCTYPE html>
<html>
<head>
    <title>Twitterok</title>
    <meta charset="windows-1251">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
    <script src="vertx-eventbus.js"></script>
	<script src="date-format.js"></script>

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script src="jquery.runner.js" type="text/javascript"></script>

    <style type="text/css">
        body
        {
			padding-top: 40px;
			padding-bottom: 40px;
			background-color: #f5f5f5;
        }

        .received
        {
			width: 160px;
			font-size: 10px;
        }
		
		.tab-content
		{
			padding:5px
		}

		.nav-tabs > li > a,
		.nav-tabs > li > a:hover
		{
			color: #3c763d;
		}

		.nav-tabs > li.active > a,
		.nav-tabs > li.active > a:focus,
		.nav-tabs > li.active > a:hover
		{
			background-color: #dff0d8 !important;
		}
		
		.nav-tabs > li 
		{
			position:relative;    
		}

		.nav-tabs > li > a 
		{
			display:inline-block;
		}

		.nav-tabs > li > #closeTab 
		{
			display:none;
			cursor:pointer;
			position:absolute;
			right: 6px;
			top: 8px;
			color: #d9534f;
		}

		.nav-tabs > li:hover > #closeTab 
		{
			display: inline-block;
		}

        #tableOnline th
        {
            text-align: center;
            vertical-align: middle;
        }


    </style>

    <script>
		
	  var host = null, port = null, id = null, uuid = null;
	  var isNewSession = true;
	  var isFirstMessage = true;
	  var isFirstMessagePrivateChat = new Map();
	  var online = 0;
	  var chats = new Map();
	  var unreadMessage = new Map();
	  
	  var eb = new EventBus("/eventbus/");
	  eb.onopen = function ()
	  {
		eb.registerHandler("data.on.chat", dataChatProcessing);
		eb.registerHandler("chat.to.client", eventChatProcessing);
	  };
	  
	  function eventChatProcessing(err, msg)
	  {
			//console.log('MSG BODY: ' + msg.body);
			
			var json = jQuery.parseJSON(msg.body);

			if (json.type == 'publish')
			{
				var t = Date.parse(json.time);
				var tf = dateFormat(t, "dd.mm.yy HH:MM:ss");

				var bgcolor = ' bgcolor="#ffffff"';

				if (host != null && port != null
				    && host == json.host && port == json.port)
				{
				    bgcolor = ' bgcolor="#dff0d8"';
				}

				var $messageLine = $('<tr' + bgcolor + '><td align="left">' + tf
					+ '</td><td align="left">' + json.host
					+ '</td><td>' + json.message
					+ '</td></tr>');

				if (isFirstMessage)
				{
					$('#tweets').append($messageLine);
					isFirstMessage = false;
				}
				else
					$('#tweets > tbody > tr:first').before($messageLine);
					
				//не прочитанные.
				var activeTab = getActiveTab();
				console.log("Publish tweet. ActiveTab: " + activeTab);
				if (activeTab != 'newTweets')
				{
					var val = unreadMessage.get("0") + 1;
					unreadMessage.set("0", val);
					//$("#badge0").disabled = false;
					document.getElementById("badge0").style.visibility = "visible";
					$("#badge0").text(val);
				}
			}

			if (json.type == 'register')
			{
				online = json.online;
				
				var isPrivateTab = isActivePrivatChatTab();
				if (!isPrivateTab)
					$('#online').text(online);

				var logonTime = new Date(json.client.logontime);
				var logonTimeFormat = dateFormat(logonTime, "HH:MM:ss");

				var privateTweetBtn = '<button style="width:100%; border:none; padding:0; background:none; outline:none;"'
							+ 'onclick="privateTweetFun(' + json.client.id + ')" title="Приватный твит">'
							+ '<span class="glyphicon glyphicon-envelope"></span></button>';

                var bgcolor = ' ';
                var title = '';
                if (isNewSession)
                {
                    bgcolor = ' bgcolor="#ffffff"';
                    privateTweetBtn = ' ';
                    isNewSession = false;
                    host = json.client.host;
                    port = json.client.port;
                    title = ' title="Вы"';
					id = json.client.id;
					uuid = json.uuid;
					console.log('Register handler: ' + uuid);
					eb.registerHandler('com.chat.' + uuid, comChatProcessing);
					//eb.registerHandler('com.chat.' + json.uuid, privateChatProcessing);
					unreadMessage.set('0', 0);
                }

				var duration = '<span id="runner' + json.client.id + '"></span>';

				var $newClient = $('<tr' + bgcolor + ' id="clientId' + json.client.id + '"' + title + '><td>' + json.client.host
					+ '</td><td>' + json.client.port
					+ '</td><td>' + logonTimeFormat
					+ '</td><td>' + duration + ' сек'
					+ '</td><td align="center" border="0">' + privateTweetBtn
					+ '</td></tr>');

				$('#tableOnline').append($newClient);

				$('#runner' + json.client.id).runner({autostart: true, milliseconds: false});
            }

			if (json.type == 'unregister')
			{
				online = json.online;
				
				var isPrivateTab = isActivePrivatChatTab();
				if (!isPrivateTab)
					$('#online').text(online);
				
				if (json.client != null)
				    $('#clientId' + json.client.id).remove();
			}
		}		  

	function comChatProcessing(err, msg)
	  {
		//Обработка информации о новых соединениях.
		console.log('Communication chat get message: ' + msg.body);
		var response = jQuery.parseJSON(msg.body);
		
		var thrown = response.thrown;
		var chatToId = String(response.chat.toId);
		var chatFromId = String(response.chat.fromId);
		var chatId = null;
		var chatAddr = String(response.chat.address);
		
		eb.registerHandler('private.chat.' + chatAddr, privateChatProcessing);
		
		if (chatToId == id)
			chatId = chatFromId;
		else
			chatId = chatToId;
			
		chats.set(chatId, 'private.server.' + chatAddr);
		unreadMessage.set(chatId, 0);
		isFirstMessagePrivateChat.set(chatId, true);
	  }
		
	  function dataChatProcessing(err, msg)
	  {
		var json = jQuery.parseJSON(msg.body);

			if (json.type == 'send')
			{
				for(var i = 0; i < json.clients.length; i++)
				{
					//console.log('host:port ' + json.clients[i].host + ':' + json.clients[i].port + ' time=' + json.clients[i].logontime);
					
					if (json.clients[i].host == json.client.host && json.clients[i].port == json.client.port)
						continue;
					
					var logonTime = new Date(json.clients[i].logontime);
					var logonTimeFormat = dateFormat(logonTime, "HH:MM:ss");
					
					//console.log('logonTime=' + logonTime + ' logonTimeFormat=' + logonTimeFormat);

					var privateTweetBtn = '<button style="width:100%; border:none; padding:0; background:none; outline:none;"'
								+ 'onclick="privateTweetFun(' + json.clients[i].id + ')" title="Приватный твит">'
								+ '<span class="glyphicon glyphicon-envelope"></span></button>';


					var duration = '<span id="runner' + json.clients[i].id + '"></span>';
	
					var $newClient = $('<tr id="clientId' + json.clients[i].id + '"><td>' + json.clients[i].host
						+ '</td><td>' + json.clients[i].port
						+ '</td><td>' + logonTimeFormat
						+ '</td><td>' + duration + ' сек'
						+ '</td><td align="center" border="0">' + privateTweetBtn
						+ '</td></tr>');

					$('#tableOnline').append($newClient);
					
					
					var passedTime = new Date().getTime() - json.clients[i].logontime;

					$('#runner' + json.clients[i].id).runner({autostart: true, startAt: passedTime, milliseconds: false});
				}
				
				eb.unregisterHandler("data.on.chat", dataChatProcessing);
			}
	  }

	  function privateChatProcessing(err, msg)
	  {
		console.log('PRIVATE CHAT, MSG=' + msg.body);
		
		var json = jQuery.parseJSON(msg.body);
		
		var t = Date.parse(json.time);
		var tf = dateFormat(t, "dd.mm.yy HH:MM:ss");
		var message = null;
		var toId = String(json.toId);
		var fromId = String(json.fromId);
		var inId = null;
		
		if (toId == id)
			inId = fromId;
		else
			inId = toId;
			
		
		var isExist = isExistTab(inId);
		if (!isExist)
		{
			if (json.type == "unregister")
				return;
			else
				createTab(inId, false);
		}
		
		var bgcolor = ' bgcolor="#ffffff"';
		
		if (json.type == "unregister")
		{
			message = 'Собеседник покинул чат';
			bgcolor = ' bgcolor="#f2dede"';
			chats.delete(inId);
		}
		else
			message = json.message;

		if (host != null && port != null
		    && host == json.host && port == json.port)
		{
		    bgcolor = ' bgcolor="#dff0d8"';
		}

		var $messageLine = $('<tr' + bgcolor + '><td align="left">' + tf
			+ '</td><td align="left">' + json.host
			+ '</td><td>' + message
			+ '</td></tr>');

		if (isFirstMessagePrivateChat.get(inId))
		{
			//console.log("IS FIRST");
			$('#privateTweets_' + inId).append($messageLine);
			isFirstMessagePrivateChat.set(inId, false);
		}
		else
		{
			//console.log("IS NOT FIRST");
			$('#privateTweets_' + inId + ' > tbody > tr:first').before($messageLine);
		}
		
		//непрочитанные.
		var activeTab = getActiveTab();
		console.log("Private tweet. ActiveTab: " + activeTab);
		if (activeTab != ('privateChat_' + inId))
		{
			var val = unreadMessage.get(inId) + 1;
			unreadMessage.set(inId, val);
			//$("#badge" + toId).disabled = false;
			document.getElementById("badge" + inId).style.visibility = "visible";
			$("#badge" + inId).text(val);
		}
				
	  }
	  
	  function isExistTab(tabId)
	  {
		var lis = $('#tabs li').map(function(i,n) 
			{
				return $(n).attr('id');
			}).get();
			
		for (var i = 0; i < lis.length; i++)
		{
			if ('tabPrivateChat_' + tabId == lis[i])
				return true;
		}
		
		return false;
	  }

	  function privateTweetFun(toId)
	  {
		console.log('ID:' + toId);
		
		var isExist = isExistTab(toId);
		console.log('isExist: ' + isExist);
		if (isExist)
		{
			//console.log('Show tab: ' + '#tabs a[href="#tabPrivateChat' + toId + '"]');
			$('#tabs a[href="#privateChat_' + toId + '"]').tab('show');
		}
		else
		{
			var info = new Object();
			info.fromId = id;
			info.toId  = toId;
			var jInfo= JSON.stringify(info);
			
			//eb.send("com.to.server", jInfo);
			if (uuid != null)
			{
				eb.send("com.server." + uuid, jInfo);
				createTab(toId, true);
			}
			else
				console.log('UUID is NULL');
		}
	  }
	  
	  function createTab(toId, show)
	  {
			var tr = $('#clientId' + toId);	
			var tdIP = $(tr).find("td:eq(0)").html();
			var tdPort = $(tr).find("td:eq(1)").html();
			
			//console.log("IP: " + tdIP + ", Port: " + tdPort);
			
			$('<li id="tabPrivateChat_' + toId +'"><a data-toggle="tab" href="#privateChat_' + toId + '">'
				+ '<span class="glyphicon glyphicon-sunglasses"></span> Приватный чат [' + tdIP + ':' + tdPort 
				+ '] <span class="badge alert-success" id="badge' + toId + '" style="visibility:hidden">0</span></a><span id="closeTab" class="glyphicon glyphicon-remove"></span></li>').appendTo('#tabs');
			
			var chatTable = '<table id="privateTweets_' + toId + '" class="table table-hover" width="100%">' +
						'<colgroup>' +
							'<col style="width:10%">' +
							'<col style="width:20%">' +
							'<col style="width:70%">' +
						'</colgroup>' +
					'</table>';
			
			$('<div class="tab-pane fade" id="privateChat_' + toId + '">'
				+ '<h3> Приватный чат [' + tdIP + ':' + tdPort + ']</h3>' + chatTable + '</div>').appendTo('.tab-content');
			
			if (show)
				$('#tabs a:last').tab('show');
				
		unreadMessage.set(toId, 0);

	  }
	  
	  function isActivePrivatChatTab()
		{
			var activeTab = getActiveTab();
			if (activeTab != 'newTweets' && activeTab != 'paneTableOnline')
				return true;
			else
				return false;
		}
		
		function getActiveTab()
		{
			var activeTab = $('.nav-tabs .active > a').attr('href').substring(1);
			console.log('Active nav-tab: ' + activeTab);
			return activeTab;
		}
		

	  $(document).ready(function()
	  {
		//отправление твита.
		$('#twit').submit(function(evt)
		{
			evt.preventDefault();
			var message = $('#message').val();
			
			if (message.length > 0)
			{
				var isPrivateTab = isActivePrivatChatTab();
				
				if (isPrivateTab)
				{
					var activeTab = getActiveTab();
					var toId = String(activeTab).split('_')[1];

					if (chats.has(toId))
					{
						var addr = chats.get(toId);
						console.log("ADDR: " + addr);
						
						eb.send(addr, message);
					}
					else
						console.log('Chat id #' + toId + ' has not.');
				}
				else
				{	
					var activeTab = getActiveTab();
					if (activeTab == 'paneTableOnline')
					{
						console.log("Open paneTableOnline");
						$('#tabs a[href="#newTweets"]').tab('show');
						//$('a[data-toggle="tab"]:first').trigger("shown.bs.tab");
					}
					
					eb.publish("chat.to.server", message);
				}
				
				$('#message').val("").focus();
				countChar();
			}
		});
		
		//переключение вкладок.
		$(document).on( 'shown.bs.tab', 'a[data-toggle="tab"]', function (e) 
		{
			var tab = String(e.target).split('#')[1];
			//console.log('TAB: ' + tab);
			
			if (tab != 'newTweets' && tab != 'paneTableOnline')
			{
				//TODO: поменять цвет.
				document.getElementById("onlineEye").style.color = "#d9534f";
				document.getElementById("online").style.color = "#d9534f";
				$('#online').text(1);
			}
			else
			{
				document.getElementById("onlineEye").style.color = "#555";
				document.getElementById("online").style.color = "#555";
				$('#online').text(online);
			}
			
			if (tab != 'paneTableOnline')
			{
				if (tab == 'newTweets')
				{
					var val = unreadMessage.get('0');
					unreadMessage.set('0', 0);
					$("#badge0").text(0);
					//$("#badge0").disabled = true;
					document.getElementById("badge0").style.visibility = "hidden";
				}
				else
				{
					var idTab = tab.split('_')[1];
					var val = unreadMessage.get(idTab);
					unreadMessage.set(idTab, 0);
					$("#badge" + idTab).text(0);
					//$("#badge" + idTab).disabled = true;
					document.getElementById("badge" + idTab).style.visibility = "hidden";
				}
			}
		});
		
		//закрыть вкладку.
		$(".nav-tabs").on("click", "#closeTab", function () 
		{
			var anchor = $(this).siblings('a');
			$(anchor.attr('href')).remove();
			$(this).parent().remove();
			$(".nav-tabs li").children('a').first().click();
		});
		
	  });
	  
	  	  
	  function countChar() 
	  {
		var len = $('#message').val().length;
        if (len > 140) 
		{
		  var msg = $('#message').val().substring(0, 140);
		  $('#message').val(msg);
        } 
		else 
		{
		  var per = 100 / 140 * len;
          $('#charNum').text(140 - len);
		  
		  
		  var per1 = (per < 20) ? per : 20;
		  var per2 = (per < 80) ? ((per1 == 20) ? (per - 20) : 0) : 60;
		  var per3 = (per > 80) ? (per - 80) : 0;
		  
			
		  $('#progress-bar1').css('width', per1+'%').attr('aria-valuenow', per1);
		  $('#progress-bar2').css('width', per2+'%').attr('aria-valuenow', per2);
		  $('#progress-bar3').css('width', per3+'%').attr('aria-valuenow', per3);
        }
      };

	</script>

</head>

<body>
<div class="container chat-wrapper">
    <form id="twit">
        <h2 align="center" class="alert alert-success">TWITTEROK</h2>
        <fieldset>
			<div class="input-group input-group-lg">
			  <span class="input-group-addon" id="onlineEye">
				<span class="glyphicon glyphicon-eye-open"></span>
			  </span>
				<span class="input-group-addon" id="online">
					<span class="glyphicon glyphicon-option-horizontal"></span>
				</span>
			  <input type="text" maxlength="141" autocomplete="off" class="form-control" placeholder="Что нового?" id="message" aria-describedby="sizing-addon1" onkeyup="countChar()"/>
			  <span class="input-group-btn">
				<button class="btn btn-success" type="submit">
				<span class="glyphicon glyphicon-send"></span></button>
			  </span>
            </div>
        </fieldset>

		<h3 id="charNum">140</h3>
		
		<div class="progress">
		  <div id="progress-bar1" class="progress-bar progress-bar-success active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="20" style="width: 0%">
			<span class="sr-only">0% Complete</span>
			</div>
			
			<div id="progress-bar2" class="progress-bar progress-bar-warning active" role="progressbar" aria-valuenow="20" aria-valuemin="20" aria-valuemax="80" style="width: 0%">
			<span class="sr-only">20% Complete</span>
			</div>
			<div id="progress-bar3" class="progress-bar progress-bar-danger active" role="progressbar" aria-valuenow="80" aria-valuemin="80" aria-valuemax="100" style="width: 0%">
			<span class="sr-only">80% Complete</span>
		  </div>
		</div>
		
		
		<!--br-->
		<!--div class="panel panel-success"-->
		<div class="container panel-success">
		  <!--div class="panel-heading"><h3>Новые твиты</h3></div-->
			<ul class="nav nav-tabs" id="tabs">
				<li class="active" id="tabNewTweets"><a data-toggle="tab" href="#newTweets">
					<span class="glyphicon glyphicon-fire"></span>
					 Новые твиты <span class="badge alert-success" id="badge0" style="visibility:hidden">0</span></a></li>
				<li id="tabPaneTableOnline"><a data-toggle="tab" href="#paneTableOnline">
					<span class="glyphicon glyphicon-user"></span>
					 Онлайн</a></li>
			</ul>

			<div class="tab-content">
				<div id="newTweets" class="tab-pane fade in active">
					<h3>Новые твиты</h3>
					<table id="tweets" class="table table-hover" width="100%">
						<colgroup>
							<col style="width:10%">
							<col style="width:20%">
							<col style="width:70%">
						</colgroup>
					</table>
				</div>

				<div id="paneTableOnline" class="tab-pane fade">
					<h3>Онлайн</h3>
					<table id="tableOnline" class="table table-hover table-bordered text-center" width="100%">
						<tr class="success">
							<th>Адрес</th>
							<th>Порт</th>
							<th>Время входа</th>
							<th>Время в сети</th>
							<th> </th>
						</tr>
					</table>
				</div>
			</div>
		</div>

    </form>
</div>
</body>
</html>