<!DOCTYPE html>
<html>
<head>
    <title>Twitterok</title>
    <meta charset="windows-1251">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--script src="https://code.jquery.com/jquery-1.11.2.min.js"></script-->
    <script src="//cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
    <script src="vertx-eventbus.js"></script>
	<script src="date-format.js"></script>
	<script src="stopwatch.js"></script>

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script src="jquery.runner.js" type="text/javascript"></script>

    <!--link href="./resource/css/bootstrap.css" rel="stylesheet"-->
    <style type="text/css">
        body
        {
			padding-top: 40px;
			padding-bottom: 40px;
			background-color: #f5f5f5;
        }

        .received
        {
			width: 160px;
			font-size: 10px;
        }

		.tab-content
		{
			padding:5px
		}

		.nav-tabs > li > a,
		.nav-tabs > li > a:hover
		{
			color: #3c763d;
		}

		.nav-tabs > li.active > a,
		.nav-tabs > li.active > a:focus,
		.nav-tabs > li.active > a:hover
		{
			background-color: #dff0d8 !important;
		}


    </style>
	<!--link href="./resource/css/bootstrap-theme.css" rel="stylesheet"-->

    <script>

	  var eb = new EventBus("/eventbus/");
	  eb.onopen = function ()
	  {
		var check = true;
		var cntOnline = 0;
		var cntMsg = 0;

		eb.registerHandler("chat.to.client", function (err, msg)
		{
			var json = jQuery.parseJSON(msg.body);

			if (json.type == 'publish')
			{
				var t = Date.parse(json.time);
				var tf = dateFormat(t, "dd.mm.yy HH:MM:ss");

				cntMsg++;
				//var bgc = '';
				var bgc = ' bgcolor="#dff0d8"';
				if (cntMsg % 2 == 0)
					bgc = ' bgcolor=\"#ffffff\"';

				var $messageLine = $('<tr' + bgc + '><td align="left">' + tf
					+ '</td><td align="left">' + json.host
					+ '</td><td>' + json.message
					+ '</td></tr>');

				if (check)
				{
					$('#tweets').append($messageLine);
					check = false;
				}
				else
					$('#tweets > tbody > tr:first').before($messageLine);
			}

			if (json.type == 'register')
			{
				$('#online').text(json.online);

				for(var i = 0; i < json.onlinelist.length; i++)
				{
					var et = Date.parse(json.onlinelist[i].logontime);
					var etf = dateFormat(et, "HH:MM:ss");
					var message = '<button style="width:100%; border:none; padding:0; background:none; outline:none;"' +
								'onclick="privateTweet(' + i + ')">' +
								'<span class="glyphicon glyphicon-envelope"></span></button>';

					var bgc2 = '';
					if (i % 2 == 1)
						bgc2 = ' bgcolor="#ffffff"';


					var duration = '<span id="runner' + i + '"></span>';

					var $newUser = $('<tr' + bgc2 + '><td>' + json.onlinelist[i].host
						+ '</td><td>' + json.onlinelist[i].port
						+ '</td><td>' + etf
						+ '</td><td>' + duration + ' сек.'
						+ '</td><td align="center" border="0">' + message
						+ '</td></tr>');

					$('#online-list').append($newUser);

					//$('#runner' + cntOnline).runner('start');
					//$('#runner' + cntOnline).runner('start');
					$('#runner' + i).runner({autostart: true, startAt: 9000000, milliseconds: false});
				}

				/*
				cntOnline++;
				$('#online').text(json.online);

				var et = Date.parse(json.logontime);
				var etf = dateFormat(et, "HH:MM:ss");
				var message = '<button style="width:100%; border:none; padding:0; background:none; outline:none;"' +
							'onclick="privateTweet(' + cntOnline + ')">' +
							'<span class="glyphicon glyphicon-envelope"></span></button>';

				var bgc2 = '';
				if (cntOnline % 2 == 1)
					bgc2 = ' bgcolor="#ffffff"';


				var duration = '<span id="runner' + cntOnline + '"></span>';

				var $newUser = $('<tr' + bgc2 + '><td>' + json.host
					+ '</td><td>' + json.port
					+ '</td><td>' + etf
					+ '</td><td>' + duration + ' сек.'
					+ '</td><td align="center" border="0">' + message
					+ '</td></tr>');

				$('#online-list').append($newUser);

				//$('#runner' + cntOnline).runner('start');
				//$('#runner' + cntOnline).runner('start');
				$('#runner' + cntOnline).runner({autostart: true, startAt: 9000000, milliseconds: false});*/
			}
		});
	  };

	  function privateTweet(num)
	  {
		alert('Num: ' + num);
	  }


	  $(document).ready(function()
	  {
		$('#twit').submit(function(evt)
		{
			evt.preventDefault();
			var message = $('#message').val();
			
			if (message.length > 0)
			{
				eb.publish("chat.to.server", message);
				$('#message').val("").focus();
				countChar();
			}
		});
		});
	  
	  function countChar() 
	  {
		var len = $('#message').val().length;
        if (len > 140) 
		{
		  var msg = $('#message').val().substring(0, 140);
		  $('#message').val(msg);
        } 
		else 
		{
		  var per = 100 / 140 * len;
          $('#charNum').text(140 - len);
		  
		  
		  var per1 = (per < 20) ? per : 20;
		  var per2 = (per < 80) ? ((per1 == 20) ? (per - 20) : 0) : 60;
		  var per3 = (per > 80) ? (per - 80) : 0;
		  
			
		  $('#progress-bar1').css('width', per1+'%').attr('aria-valuenow', per1);
		  $('#progress-bar2').css('width', per2+'%').attr('aria-valuenow', per2);
		  $('#progress-bar3').css('width', per3+'%').attr('aria-valuenow', per3);
        }
      };

	</script>

</head>

<body>
<div class="container chat-wrapper">
    <form id="twit">
        <h2 align="center" class="alert alert-success">TWITTEROK</h2>
        <fieldset>
			<div class="input-group input-group-lg">
			  <span class="input-group-addon">
				<span class="glyphicon glyphicon-eye-open"></span>
			  </span>
				<span class="input-group-addon" id="online">
					<span class="glyphicon glyphicon-option-horizontal"></span>
				</span>
			  <input type="text" maxlength="141" autocomplete="off" class="form-control" placeholder="Что нового?" id="message" aria-describedby="sizing-addon1" onkeyup="countChar()"/>
			  <span class="input-group-btn">
				<button class="btn btn-success" type="submit">
				<span class="glyphicon glyphicon-send"></span></button>
			  </span>
            </div>
        </fieldset>

		<h3 id="charNum">140</h3>
		
		<div class="progress">
		  <div id="progress-bar1" class="progress-bar progress-bar-success active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="20" style="width: 0%">
			<span class="sr-only">0% Complete</span>
			</div>
			
			<div id="progress-bar2" class="progress-bar progress-bar-warning active" role="progressbar" aria-valuenow="20" aria-valuemin="20" aria-valuemax="80" style="width: 0%">
			<span class="sr-only">20% Complete</span>
			</div>
			<div id="progress-bar3" class="progress-bar progress-bar-danger active" role="progressbar" aria-valuenow="80" aria-valuemin="80" aria-valuemax="100" style="width: 0%">
			<span class="sr-only">80% Complete</span>
		  </div>
		</div>
		
		
		<!--br-->
		<!--div class="panel panel-success"-->
		<div class="container panel-success">
		  <!--div class="panel-heading"><h3>Новые твиты</h3></div-->
			<ul class="nav nav-tabs">
				<li class="active"><a data-toggle="tab" href="#newt">
					<span class="glyphicon glyphicon-fire"></span>
					 Новые твиты</a></li>
				<li><a data-toggle="tab" href="#onlinet">
					<span class="glyphicon glyphicon-user"></span>
					 Онлайн</a></li>
				<li><a data-toggle="tab" href="#chatt">
					<span class="glyphicon glyphicon-sunglasses"></span>
					 Приватный чат</a></li>
			</ul>

			<div class="tab-content">
				<div id="newt" class="tab-pane fade in active">
					<h3>Новые твиты</h3>
					<table id="tweets" class="table table-hover" width="100%">
						<colgroup>
							<col style="width:10%">
							<col style="width:20%">
							<col style="width:70%">
						</colgroup>
					</table>
				</div>

				<div id="onlinet" class="tab-pane fade">
					<h3>Онлайн</h3>
					<table id="online-list" class="table table-hover table-bordered" width="100%">
						<tr class="success" align="center">
							<th>Адрес</th>
							<th>Порт</th>
							<th>Время входа</th>
							<th>Время в сети</th>
							<th>Приватный твит</th>
						</tr>
					</table>
				</div>

				<div id="chatt" class="tab-pane fade">
					<h3>Приватный чат</h3>
					<p>Приватный чат один на один.</p>
				</div>
			</div>
		</div>

    </form>
</div>
</body>
</html>